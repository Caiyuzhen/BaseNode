var express = require('express')
var router = express.Router()
const UserAuthModel = require('../../models/UserModel.js')
const md5 = require('md5')// md5 åŠ å¯†æ•°æ®åŒ…


/**
 * 1.æ„å»º Express è·¯ç”±
 * 2.æ„å»º userAuthModels æ¨¡å‹æ¥æ“ä½œæ•°æ®åº“, åšä¸€ä¸ªä¸­é—´ä»¶æ¥æ£€æµ‹ã€ç½‘é¡µç«¯ã€‘çœ‹æ˜¯å¦æœ‰ç”¨æˆ·ç™»å½•çš„ session, æ•°æ®ç”¨ md5 åŠ å¯†
 * 3.ç”¨ npm i jsonwebtoken æ¥ç”Ÿæˆ token, ç”¨æ¥åšã€æ¥å£ç«¯ã€‘çš„é™åˆ¶, ä¸ç„¶æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®æ¥å£
 	* ğŸŒŸä¸‹é¢çš„æ¥å£å®šä¹‰å¥½åè®°å¾—åœ¨ app.js å†…è¿›è¡Œå¯¼å…¥ !!
 */

// æ¸²æŸ“æ³¨å†Œé¡µé¢ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
router.get('/reg', (req, res) => {
	// å“åº” html é¡µé¢
	res.render('auth/reg') //å‰ææ˜¯è¦åœ¨ app.js æ–‡ä»¶ä¸­å¯¼å…¥!  var indexRouter = require('./routes/webRenderApi/auth.js')
})


// å¤„ç†ç”¨æˆ·æ³¨å†Œçš„è¯·æ±‚
router.post('/reg', (req, res) => {
	// è¿™é‡Œè¿˜å¯ä»¥åšåç«¯çš„è¡¨å•éªŒè¯...
	//è¡¨å•éªŒè¯çš„ä»£ç ...

	// è·å–è¯·æ±‚ä½“æ•°æ®
	console.log(req.body) // é€šè¿‡ req.body è·å–ç”¨æˆ·æ³¨å†Œçš„æ•°æ®

	// ğŸŒŸæ“ä½œæ•°æ®åº“, æŠŠæ•°æ®å†™å…¥ MongoDB !!
	// UserAuthModel.create(req.body) //å› ä¸ºè·å–çš„æ•°æ®å°±æ˜¯ä¸ªå¯¹è±¡ {}, æ‰€ä»¥ä¸ç”¨ {} äº†
	UserAuthModel.create({
		...req.body,  //å…ˆå…¨éƒ¨å±•å¼€
		password: md5(req.body.password)  //ä¹Ÿå¯ä»¥æŠŠ body å†…çš„å¯¹è±¡è¿›è¡Œã€å…¨éƒ¨å±•å¼€ã€‘ + ã€éƒ¨åˆ†å•ç‹¬å®šåˆ¶ã€‘
	}) 
	.then(data => {
		res.render('success', {msg: 'æ³¨å†ŒæˆåŠŸ', url: '/login'}) //ä¼ ç»™ ejs çš„æ•°æ®
		// res.send('æ³¨å†ŒæˆåŠŸ') //render ä¹‹åå°±ä¸èƒ½å† send äº†
	})
	.catch(err => {
		console.log(err)
		res.status(500).send('Server Error, æ³¨å†Œå¤±è´¥')
		return
	})
})



// æ¸²æŸ“ç™»å½•é¡µé¢ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
router.get('/login', (req, res) => {
	// å“åº” html é¡µé¢
	res.render('auth/login') //å‰ææ˜¯è¦åœ¨ app.js æ–‡ä»¶ä¸­å¯¼å…¥!  var indexRouter = require('./routes/webRenderApi/auth.js')
})


// å¤„ç†ç”¨æˆ·ç™»å½•çš„è¯·æ±‚
router.post('/login', (req, res) => {
	// ğŸŒŸæŸ¥è¯¢æ•°æ®åº“, çœ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰è¿™ä¸ªç”¨æˆ·çš„æ•°æ®
	//å…ˆè·å–ç”¨æˆ·åè·Ÿå¯†ç 
	let { username, password }  = req.body

	// ç„¶åæŸ¥è¯¢æ•°æ®åº“
	UserAuthModel.findOne({ username: username, password: md5(password)}) //ğŸ”¥ğŸ‘ˆæŠŠç”¨æˆ·ç™»å½•è¾“å…¥çš„å¯†ç ä¹Ÿåšä¸€æ¬¡ md5 çš„åŠ å¯†ğŸ”, ç„¶åå†å»åŒ¹é…æ•°æ®åº“
	.then(data => {
		// ğŸš€åˆ¤æ–­ data æ˜¯å¦å‡ºé”™ï¼ˆæ²¡æœ‰è¿™ä¸ªè´¦å·æˆ–è€…è´¦å·å‡ºé”™ï¼‰
		if(!data) {
			return res.send('è´¦å·æˆ–è€…å¯†ç å‡ºé”™')
		} else {
			// ç™»å½•æˆåŠŸçš„å“åº”
			req.session.username = data.username // ğŸ‘‰ ç›¸å½“äºæŠŠç”¨æˆ·åå­˜å‚¨åˆ°æ•°æ®åº“ä¸­, å› ä¸ºä¸Šé¢ app.use(session({...})) å·²ç»åšäº†æ‹¦æˆª, æ–‡æ¡£åç§°ä¸º session  //ğŸ‘ˆ å› ä¸º npm i express-session connect-mongo çš„ä¸­é—´ä»¶å·²ç»åšäº†å¤„ç†
			req.session._id = data._id //ç”¨æˆ· mongoDB æ–‡æ¡£çš„ id

			res.render('success', {msg: 'ç™»å½•æˆåŠŸ', url: '/account'}) //ä¼ ç»™ ejs çš„æ•°æ®
			// res.send('ç™»å½•æˆåŠŸ') //render ä¹‹åå°±ä¸èƒ½å† send äº†
		}
	})
	.catch(err => {
		console.log(err)
		res.status(500).send('Server Error, ç™»å½•å¤±è´¥, è¯·ç¨åå†è¯•')
		return
	})
})


// å¤„ç†é€€å‡ºçš„è¯·æ±‚ â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
router.post('/logout', (req, res) => {
	// é”€æ¯ session
	req.session.destroy(() => {
		res.render('success', {msg: 'é€€å‡ºæˆåŠŸ', url: '/login'})
	})
})


module.exports = router